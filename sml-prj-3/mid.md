# 中間発表レポート

## 1. 要求仕様

### 1.1. 目的

麻雀における大変な作業を自動化したい。
難しいところを自動化することで、初心者でも楽しめるようにする。
↓
麻雀の点数計算, 安牌の推定, ドラの表示を自動化する。

### 1.2. システム概要

1. ネット麻雀のスクリーンショットを入力とする。
2. そのスクリーンショットに写っている牌を認識する。
3. 認識結果に基づいて
   - それぞれのプレイヤーに対する安牌を推定する。
   - 点数計算を行う。
4. 結果を出力する。
   入力画像に色を付けたり枠を描画したりして、認識結果を表示する。
5. ドラを表示する。

## 2. 概要設計

### 2.1. 学習データ

ネット麻雀のスクリーンショットを 4 つに分割して、それぞれの牌をラベル付けする。

もとはスクリーンショットをそのまま使用していたが、20 枚程度で学習を行ったところ、1 枚も認識されなかった。
↓
スクリーンショットを 4 つに分割することで、牌の大きさが大きくなるとともに画像の量も 4 倍になる。

### 2.2. 使用する技術

#### 学習データの作成

##### 画像の分割

python を使用して、スクリーンショットを 4 つに分割する。
画像情報を OpenCV で取得し、その配列のスライスを OpenCV で画像として保存する。

```python
import cv2
import os

# 画像を四つに分割して保存する
def split(img_path, save_dir="splitted_data"):
    if not os.path.exists(save_dir):
        os.makedirs(save_dir)
    img = cv2.imread(img_path)
    h, w = img.shape[:2]
    h = h // 2
    w = w // 2
    img1 = img[:h, :w]
    img2 = img[:h, w:]
    img3 = img[h:, :w]
    img4 = img[h:, w:]
    cv2.imwrite(
        os.path.join(save_dir, os.path.basename(img_path)).replace(".png", "_1.png"),
        img1,
    )
    cv2.imwrite(
        os.path.join(save_dir, os.path.basename(img_path)).replace(".png", "_2.png"),
        img2,
    )
    cv2.imwrite(
        os.path.join(save_dir, os.path.basename(img_path)).replace(".png", "_3.png"),
        img3,
    )
    cv2.imwrite(
        os.path.join(save_dir, os.path.basename(img_path)).replace(".png", "_4.png"),
        img4,
    )
```

#### 物体検出

YOLOv5 を使用する。

#### 画像の描画

OpenCV を使用する。

#### リアルタイム処理

ネット麻雀の画面を OBS でキャプチャし、仮想カメラとして出力することで OpenCV でフレームを取得する。

## 3. タスクとスケジュール

大まかにデータ準備, コーディング, グループ関係の３つに分け、各班員は自分が得意なものを担当する。

自分はコーディングを担当する。
現在は、それぞれの牌の認識された情報を処理するところまでできている（閾値の調整は必要）。

画像を分割するコードも作成した。
その際に、すでにラベル付けを終えたデータがあったので、それもラベルデータとともに 4 つに分割した。

## 4. 現状

### 4.1. 認識

200 枚程度の画像を用いて学習をエポック 600 で学習させたところ、それなりの精度で認識できた。
もう少し画像とエポックを増やせばかなりの精度で認識できると思われる。

また、赤ドラの数が少ないため、赤ドラの認識がうまくいかない。
赤ドラだけ別でラベル付けして量を増やす必要がある。
もしくは、赤ドラは普通の牌として認識し、その後に赤ドラの数を入力するようにする（赤ドラは点数計算の際のみ必要）。

エポックを増やすと学習時間がかかるため、学内サーバ等を使用する必要が出るかもしれない。

### 4.2. コーディング

画像の分割, 認識された牌の処理, 安牌の推定までできている。

安牌の推定は、認識された牌の数を元に、残りの牌を推定する。
また、それぞれのプレイヤーが捨てた牌を元に、安牌を推定する。

## 5. 今後の予定

- 認識の精度を上げる。
- 赤ドラの認識を改善する。
- 点数計算を行う。
- ドラを表示する。
- それぞれの結果を画像に描画する。
